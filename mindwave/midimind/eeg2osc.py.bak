import time, glob, os, csv
import numpy as np

from pythonosc import udp_client
from pythonosc import osc_message_builder
from pythonosc import osc_bundle_builder

# OS friendly formatting
os.system('cls' if os.name == 'nt' else 'clear')

# find most recent folder and file
dir = max([f.path for f in os.scandir('../EEG_data/') if f.is_dir()])
file = max(glob.glob(os.path.join(dir, 'EEGlog_*.csv')),key=os.path.getctime)

# define ip and port
port =  57120		# sc
ip = '192.168.1.26'	# sc

# setup OSC server
sender = udp_client.SimpleUDPClient(ip, port)

while True:

# Get data
  data = np.genfromtxt(file, dtype=int, delimiter=',', names=True)
  #print(data[-1])

  line = data[-1]
  for i in range(4, 12):
    line[i] = np.round(np.log(line[i]))
  print (line)

  
    
  # Build and send OSC message
  msg = osc_message_builder.OscMessageBuilder(address = 'eeg')
  for value in line:   
      msg.add_arg(value, arg_type='i')
  msg = msg.build()
  sender.send(msg)
  time.sleep(1)
)

#  bundle = osc_bundle_builder.OscBundleBuilder(
#    osc_bundle_builder.IMMEDIATELY)
#    
#  msg = osc_message_builder.OscMessageBuilder(address="/eeg/time")
#  msg.add_arg(int(line[1]))
#  bundle.add_content(msg.build())
#  
#  msg = osc_message_builder.OscMessageBuilder(address="/eeg/atn")
#  msg.add_arg(int(line[2]))
#  bundle.add_content(msg.build())
#
#  msg = osc_message_builder.OscMessageBuilder(address="/eeg/med")
#  msg.add_arg(int(line[3]))
#  bundle.add_content(msg.build())
#
#  msg = osc_message_builder.OscMessageBuilder(address="/eeg/delta")
#  msg.add_arg(int(line[4]))
#  bundle.add_content(msg.build())
#
#  for i in range (4,12):
#    msg = osc_message_builder.OscMessageBuilder(address="/EEG/" + labels[i])
#    msg.add_arg(line[i])  
#    bundle.add_content(msg.build())
#  
#  bundle = bundle.build()
#  sender.send(bundle)
#  time.sleep(1)
  
